name: Airbnb Scraper AI Vision

on:
  workflow_dispatch:
    inputs:
      workflow_name:
        description: "Nom de cette exÃ©cution (ex: Dubai_Marina_Run1)"
        required: true
        default: "Dubai_Run"
      max_listings_per_page:
        description: "Nombre max d'annonces PAR page de recherche"
        required: true
        default: "20"

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python dependencies
        run: |
          python -m pip install playwright
          python -m playwright install --with-deps chromium

      - name: Install Node dependencies
        run: |
          npm install

      - name: Verify search_urls.txt exists
        run: |
          if [ ! -f search_urls.txt ]; then
            echo "âŒ ERREUR: Fichier search_urls.txt introuvable!"
            echo "CrÃ©ez ce fichier avec vos URLs de pages de recherche (une URL par ligne)"
            exit 1
          fi
          echo "âœ… Fichier search_urls.txt trouvÃ©"
          echo "ğŸ“‹ Contenu:"
          cat search_urls.txt

      - name: Phase 1 - Scrape Listings
        env:
          MAX_LISTINGS: ${{ inputs.max_listings_per_page }}
          MAX_MINUTES: "15"
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” PHASE 1 : Scraping des annonces"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          python scrape_listings.py
          
          if [ -f airbnb_results.csv ]; then
            echo "âœ… Phase 1 terminÃ©e"
            echo "ğŸ“Š Nombre de lignes: $(wc -l < airbnb_results.csv)"
          else
            echo "âŒ Erreur Phase 1"
            exit 1
          fi

      - name: Phase 2 - Screenshots & AI Analysis
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          SOURCE_WORKFLOW: ${{ inputs.workflow_name }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¸ PHASE 2 : Screenshots + Envoi n8n"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          node screenshot_and_send.js

      - name: Upload Phase 1 Results
        uses: actions/upload-artifact@v4
        with:
          name: phase1-listings-csv
          path: airbnb_results.csv
        if: always()

      - name: Upload Phase 2 Report
        uses: actions/upload-artifact@v4
        with:
          name: phase2-processing-report
          path: phase2_report.json
        if: always()

      - name: Display Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DE L'EXÃ‰CUTION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f phase2_report.json ]; then
            echo "âœ… Rapport Phase 2 disponible"
            echo "ğŸ“¥ TÃ©lÃ©chargez les artifacts pour voir les dÃ©tails"
          fi
```

---

## ğŸ” **CORRIGER LE SECRET GITHUB**

**Va dans Settings â†’ Secrets and variables â†’ Actions** :

1. Si le secret `N8N_WEBHOOK_URL` existe dÃ©jÃ , clique dessus puis **Update**
2. Sinon, clique **New repository secret**
3. Remplis :
   - **Name** : `N8N_WEBHOOK_URL`
   - **Value** : `https://n8n.srv843989.hstgr.cloud/webhook/airbnb-host-ai`
4. **Save**

---

## ğŸ“‹ **RÃ‰CAPITULATIF DE CE QUI A CHANGÃ‰**

### **âœ… Nouveau fichier crÃ©Ã©** :
- `search_urls.txt` â†’ Tu y colles tes 15 URLs de pages de recherche

### **âœ… Fichiers modifiÃ©s** :
- `scrape_listings.py` â†’ Lit maintenant `search_urls.txt` et traite TOUTES les pages
- `.github/workflows/scrape-airbnb-ai.yml` â†’ Ne demande plus l'URL en input, lit le fichier

### **âœ… URL webhook corrigÃ©e** :
- `https://n8n.srv843989.hstgr.cloud/webhook/airbnb-host-ai`

---

## ğŸ¯ **COMMENT UTILISER MAINTENANT**

### **Ã‰tape 1 : PrÃ©parer tes URLs**

Dans le fichier `search_urls.txt`, colle tes URLs (exemple) :
```
https://fr.airbnb.ca/s/JVC--Dubai--United-Arab-Emirates/homes?items_offset=0
https://fr.airbnb.ca/s/JVC--Dubai--United-Arab-Emirates/homes?items_offset=18
https://fr.airbnb.ca/s/JVC--Dubai--United-Arab-Emirates/homes?items_offset=36
https://fr.airbnb.ca/s/Dubai-Marina--Dubai--United-Arab-Emirates/homes?items_offset=0
https://fr.airbnb.ca/s/Dubai-Marina--Dubai--United-Arab-Emirates/homes?items_offset=18
```

### **Ã‰tape 2 : Lancer le workflow**

1. Va dans **Actions**
2. Clique **"Airbnb Scraper AI Vision"**
3. Clique **"Run workflow"**
4. Remplis :
```
   Nom de l'exÃ©cution : Dubai_Marina_JVC_Run1
   Nombre max d'annonces PAR page : 20
```
5. Lance !

**Le workflow va** :
- Lire les 5 URLs dans `search_urls.txt`
- Pour chaque URL, collecter jusqu'Ã  20 annonces
- Total : ~100 annonces (5 pages Ã— 20 annonces)
- Scraper chaque annonce
- Prendre screenshot de chaque hÃ´te
- Envoyer Ã  n8n
- Remplir Google Sheet

---

## ğŸ§ª **TEST AVEC 2 URLs**

Pour tester, mets juste 2 URLs dans `search_urls.txt` :
```
https://fr.airbnb.ca/s/Dubai/homes?items_offset=0
https://fr.airbnb.ca/s/Dubai/homes?items_offset=18
